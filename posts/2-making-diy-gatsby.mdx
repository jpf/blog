---
title: "Making a do-it-yourself Gatsby"
slug: "2-making-diy-gatsby"
createdAt: "2021-03-04"
coverImage: "/img/2/cover.png"
description: >
  Over-engineering can be a great learning experience. If it feels fun,
  just go for it! Casual projects can break the rules.
tags:
  - over-engineering
  - react
  - server-side rendering
  - gatsby
---

*This post focuses on the technical implementation of the site. For motivation and background, take a look at ["kimmo.blog doesn't want to know your location"](../1-kimmo-blog-doesnt-want-to-know-your-location/)*.


To set the correct expectations, the post title is slightly overselling. Gatsby has much more features than the self rolled site generator this blog has been built with. In any case, the generator does everything I need, and does it in "just" (TODO add link) about [500 lines of code](https://github.com/kimmobrunfeldt/blog/blob/main/src/generator/render.tsx).


I had some ideas of the tooling:

* Output is a static site directory
* *"Unix"* build pipeline using CLI tools and file transforms
* MDX support for content
* Minimal page bundle sizes
* No frontend routing or data fetching. New page load for each route change
* No hot reload



## How does the generator work?

The aim was a simple build pipeline that is a bunch of CLI commands. The end result is quite simple considering the task, but lack of hot reloading makes the iteration somewhat slow (5-10s after each file change).

![Build pipeline](/img/2/build-pipeline.svg)


Production build with approximate times:

### 1. Generate pages

For each regular page under [src/pages](https://github.com/kimmobrunfeldt/blog/blob/main/src/pages), generate:

  * `index.html` the main HTML for the page.
  * `hydrate.tsx` the script that `React.hydrate`s the given page when loaded at frontend. *The static parts of the page work without this script.*

For each MDX post under [posts/](https://github.com/kimmobrunfeldt/blog/blob/main/posts), generate:

* `index.html`
* `<postName>-post-hydrate.tsx` same as above, except it imports `PostPage` component that is also generated dynamically
* `<postName>-post.tsx` responsible for hydrating the MDX content

    Note that hydrate is *not* the same as `React.hydrate`. Instead it uses [next-mdx-remote](https://github.com/hashicorp/next-mdx-remote/)'s
    hydrate. The flow is:

    * Node.js process renders MDX content to HTML string, and also transpiles the MDX content into a React component code. The code is quite short and well commented: https://github.com/hashicorp/next-mdx-remote/blob/main/render-to-string.js

    * Frontend takes in the rendered HTML, and babel transpiled component code and starts the dynamic components in frontend. See [next-mdx-remote/blob/main/hydrate.js)](https://github.com/hashicorp/next-mdx-remote/blob/main/hydrate.js)

* `compiledSource.txt` The MDX component source code transpiled with Babel, mentioned above

    We need to be able to transfer the text contents exactly as-is to the frontend. A good way to do this
    was using a rollup text plugin, which is used in the next steps. `.txt` extension is used just to make
    configuring the rollup plugin easier.

    It used to be just a simple regex
    replacement in `<postName>-post.tsx` file, but it broke with line breaks.

* `renderedOutput.txt` The HTML content of the MDX blog post.

* `site-data.json` file that contains all metadata of the site, including pages
* `prism-theme.css` contains dynamically rendered Prism theme CSS, based on [tailwind.config.js](https://github.com/kimmobrunfeldt/blog/blob/main/tailwind.config.js)

### 2. Bundle pages

Bundles the dynamically created files for each page to one JS bundle per page

Rollup seemed like a good fit for this type of setup where we want absolute control over the build. Rollup requires quite precise configuration, the following plugins are used:

* `replace` module to e.g. take either dev or prod version of React
* `nodeResolve` module to make rollup follow `require('react')` calls into node_modules and include them into the bundle
* `string` to include the text files in JS code
* `commonjs`
* `json` to be able to import json file (site data)
* `typescript`

### 3. PostCSS

Generate distributable CSS file with PostCSS. The site uses Tailwind for CSS styling.


### 4. Copy static files

Copy everything from [public/](https://github.com/kimmobrunfeldt/blog/blob/main/public/) to the root of output.

### 5. Minify

Validate accssibility of the HTML and minify the output.

### 6. Generate RSS

Generate RSS feed of the posts using [node-rss](https://www.npmjs.com/package/rss).

### 7. Lighthouse

Build a Lighthouse CI report which is deployed to https://kimmo.blog/perf. It is being ran in Netlify's slow build machine, so performance shows lower than it should.
